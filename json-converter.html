<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Advanced JSON Converter</title>
		<!-- Bootstrap CSS -->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<style>
			body {
				padding-top: 1rem;
				background: #f4f6f8;
			}
			textarea {
				font-family: monospace;
				resize: vertical;
				height: 200px;
			}
			#errorMsg {
				display: none;
			}
		</style>
	</head>
	<body class="container-fluid">
		<h1 class="text-center mb-4">Advanced JSON Converter</h1>

		<div class="row gx-3">
			<!-- Input Panel -->
			<div class="col-lg-6 mb-4">
				<div class="card h-100">
					<div class="card-header bg-primary text-white">Input JSON</div>
					<div class="card-body d-flex flex-column">
						<textarea
							id="jsonInput"
							class="form-control mb-2"
							placeholder="Paste or drop JSON here…"
						></textarea>
						<div id="errorMsg" class="alert alert-danger py-1 mb-2"></div>
						<div class="d-flex flex-wrap gap-2">
							<input
								type="file"
								id="fileInput"
								class="form-control form-control-sm w-auto"
								accept=".json"
							/>
							<button
								class="btn btn-sm btn-outline-secondary"
								data-action="validate"
							>
								Validate
							</button>
							<button
								class="btn btn-sm btn-outline-secondary"
								data-action="pretty"
							>
								Pretty Print
							</button>
							<button
								class="btn btn-sm btn-outline-secondary"
								data-action="minify"
							>
								Minify
							</button>
							<!-- Conversion buttons -->
							<div class="dropdown">
								<button
									class="btn btn-sm btn-outline-secondary dropdown-toggle"
									data-bs-toggle="dropdown"
								>
									Convert…
								</button>
								<ul class="dropdown-menu">
									<li>
										<a
											class="dropdown-item convert-item"
											href="#"
											data-format="csv"
											>To CSV</a
										>
									</li>
									<li>
										<a
											class="dropdown-item convert-item"
											href="#"
											data-format="xml"
											>To XML</a
										>
									</li>
									<li>
										<a
											class="dropdown-item convert-item"
											href="#"
											data-format="yaml"
											>To YAML</a
										>
									</li>
									<li>
										<a
											class="dropdown-item convert-item"
											href="#"
											data-format="toml"
											>To TOML</a
										>
									</li>
									<li>
										<a
											class="dropdown-item convert-item"
											href="#"
											data-format="sql"
											>To SQL</a
										>
									</li>
									<li>
										<a
											class="dropdown-item convert-item"
											href="#"
											data-format="markdown"
											>To Markdown</a
										>
									</li>
									<li>
										<a
											class="dropdown-item convert-item"
											href="#"
											data-format="ini"
											>To INI</a
										>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Output Panel -->
			<div class="col-lg-6 mb-4">
				<div class="card h-100">
					<div class="card-header bg-secondary text-white">
						Output & Tree View
					</div>
					<div class="card-body d-flex flex-column">
						<textarea
							id="jsonOutput"
							class="form-control mb-2"
							readonly
							placeholder="Result will appear here…"
						></textarea>
						<div class="d-flex gap-2 mb-2">
							<button class="btn btn-sm btn-outline-primary" id="copyBtn">
								Copy
							</button>
							<button class="btn btn-sm btn-outline-primary" id="downloadBtn">
								Download
							</button>
							<button class="btn btn-sm btn-outline-secondary" id="themeToggle">
								Dark Mode
							</button>
						</div>
						<div
							class="accordion flex-grow-1 overflow-auto"
							id="treeAccordion"
						></div>
					</div>
				</div>
			</div>
		</div>

		<!-- External libs -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@iarna/toml@2.2.5/umd/toml.min.js"></script>

		<script>
			(() => {
				const input = document.getElementById("jsonInput");
				const output = document.getElementById("jsonOutput");
				const errorMsg = document.getElementById("errorMsg");
				const treeAcc = document.getElementById("treeAccordion");

				// Utility: show inline error
				function showError(msg) {
					errorMsg.textContent = msg;
					errorMsg.style.display = "block";
				}
				function clearError() {
					errorMsg.style.display = "none";
				}

				// Generic convert function
				const converters = {
					pretty: (txt) => JSON.stringify(JSON.parse(txt), null, 2),
					minify: (txt) => JSON.stringify(JSON.parse(txt)),
					csv: (txt) => {
						const arr = JSON.parse(txt);
						if (!Array.isArray(arr)) throw new Error("Root must be an array");
						const cols = [...new Set(arr.flatMap((o) => Object.keys(o)))];
						return [
							cols.join(","),
							...arr.map((r) =>
								cols.map((k) => JSON.stringify(r[k] || "")).join(",")
							),
						].join("\n");
					},
					xml: (txt) => {
						const toXml = (o, tag = "root") =>
							Array.isArray(o)
								? o.map((v) => toXml(v, tag)).join("")
								: typeof o === "object"
								? `<${tag}>${Object.entries(o)
										.map(([k, v]) => toXml(v, k))
										.join("")}</${tag}>`
								: `<${tag}>${String(o)}</${tag}>`;
						return toXml(JSON.parse(txt));
					},
					yaml: (txt) => jsyaml.dump(JSON.parse(txt), { indent: 2 }),
					toml: (txt) => TOML.stringify(JSON.parse(txt)),
					sql: (txt) => {
						const arr = JSON.parse(txt);
						if (!Array.isArray(arr)) throw new Error("Root must be an array");
						const keys = Object.keys(arr[0]);
						const rows = arr.map(
							(o) =>
								"(" +
								keys
									.map((k) => `'${String(o[k] || "").replace(/'/g, "''")}'`)
									.join(",") +
								")"
						);
						return `INSERT INTO table (${keys.join(",")}) VALUES\n${rows.join(
							",\n"
						)};`;
					},
					markdown: (txt) => {
						const arr = JSON.parse(txt);
						if (!Array.isArray(arr)) throw new Error("Root must be an array");
						const keys = Object.keys(arr[0]);
						const header = `|${keys.join("|")}|`;
						const sep = `|${keys.map(() => "-").join("|")}|`;
						const rows = arr.map((r) => `|${keys.map((k) => r[k]).join("|")}|`);
						return [header, sep, ...rows].join("\n");
					},
					ini: (txt) => {
						const obj = JSON.parse(txt);
						return Object.entries(obj)
							.map(([sec, val]) => {
								const body = Object.entries(val)
									.map(([k, v]) => `${k}=${v}`)
									.join("\n");
								return `[${sec}]\n${body}`;
							})
							.join("\n\n");
					},
				};

				// Render tree into Bootstrap accordion
				function renderTree(txt) {
					let data;
					try {
						data = JSON.parse(txt);
					} catch {
						treeAcc.innerHTML = '<div class="text-danger">Invalid JSON</div>';
						return;
					}

					treeAcc.innerHTML = "";
					let idCounter = 0;
					function recurse(obj, parentId) {
						const card = document.createElement("div");
						card.className = "accordion-item";
						const headingId = `heading${++idCounter}`;
						const collapseId = `collapse${idCounter}`;

						// Header
						const header = document.createElement("h2");
						header.className = "accordion-header";
						header.id = headingId;
						header.innerHTML = `
          <button class="accordion-button ${
						parentId ? "collapsed" : ""
					}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
            ${parentId || "root"} (${Array.isArray(obj) ? "Array" : "Object"})
          </button>`;
						card.append(header);

						// Body
						const bodyWrapper = document.createElement("div");
						bodyWrapper.id = collapseId;
						bodyWrapper.className = `accordion-collapse collapse ${
							parentId ? "" : "show"
						}`;
						bodyWrapper.setAttribute("data-bs-parent", "#treeAccordion");
						const body = document.createElement("div");
						body.className = "accordion-body ps-4";
						for (let k in obj) {
							const val = obj[k];
							if (val && typeof val === "object") {
								recurse(val, k);
							} else {
								const p = document.createElement("p");
								p.textContent = `${k}: ${JSON.stringify(val)}`;
								body.append(p);
							}
						}
						bodyWrapper.append(body);
						card.append(bodyWrapper);
						treeAcc.append(card);
					}
					recurse(data, null);
				}

				// Bind static buttons
				document.querySelectorAll("[data-action]").forEach((btn) => {
					btn.addEventListener("click", () => {
						clearError();
						try {
							const fmt = btn.dataset.action;
							const res = converters[fmt](input.value);
							output.value = res;
							renderTree(res);
						} catch (e) {
							showError(e.message);
						}
					});
				});

				// Bind conversion menu
				document.querySelectorAll(".convert-item").forEach((link) => {
					link.addEventListener("click", (e) => {
						e.preventDefault();
						clearError();
						try {
							const fmt = link.dataset.format;
							const res = converters[fmt](input.value);
							output.value = res;
							renderTree(res);
						} catch (e) {
							showError(e.message);
						}
					});
				});

				// File input
				document.getElementById("fileInput").addEventListener("change", (e) => {
					const file = e.target.files[0];
					if (!file) return;
					const reader = new FileReader();
					reader.onload = () => {
						input.value = reader.result;
						clearError();
						renderTree(reader.result);
					};
					reader.readAsText(file);
				});

				// Copy & download
				document.getElementById("copyBtn").onclick = () =>
					navigator.clipboard.writeText(output.value);
				document.getElementById("downloadBtn").onclick = () => {
					const blob = new Blob([output.value], { type: "text/plain" });
					const url = URL.createObjectURL(blob);
					const a = document.createElement("a");
					a.href = url;
					a.download = "output.txt";
					a.click();
					URL.revokeObjectURL(url);
				};

				// Dark mode toggle
				document.getElementById("themeToggle").onclick = () =>
					document.body.classList.toggle("bg-dark") ||
					document.body.classList.toggle("text-light");

				// Initial render
				renderTree("{}");
			})();
		</script>
	</body>
</html>
