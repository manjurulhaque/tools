<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Advanced Image to PDF Converter — Client-side, Privacy-first</title>

<!-- SEO meta -->
<link rel="canonical" href="https://example.com/image-to-pdf" />
<meta name="description" content="Convert images to PDF quickly and privately in your browser. Reorder, crop, rotate, compress, watermark and export images to PDF without uploading files. Supports PNG, JPEG, WebP." />
<meta name="keywords" content="image to pdf, convert images to pdf, jpeg to pdf, png to pdf, webp to pdf, client-side PDF, image compression, image watermark, pdf metadata, image crop, rotate" />
<meta property="og:title" content="Advanced Image to PDF Converter — Client-side, Privacy-first" />
<meta property="og:description" content="Convert images to PDF quickly and privately in your browser. Reorder, crop, rotate, compress, watermark and export images to PDF without uploading files." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://example.com/image-to-pdf" />
<meta property="og:image" content="https://example.com/assets/og-image.png" />
<meta name="twitter:card" content="summary_large_image" />

<!-- Structured data (FAQ + software info) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Image → PDF Converter",
  "url": "https://example.com/image-to-pdf",
  "description": "Client-side image to PDF converter with cropping, rotating, compression and watermarking. No uploads — all processing occurs in the browser.",
  "applicationCategory": "BusinessApplication",
  "operatingSystem": "Web",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
  "featureList": [
    "Convert PNG/JPEG/WebP to PDF",
    "Reorder pages with drag & drop",
    "Crop and rotate per-image",
    "Image compression and DPI control",
    "Optional watermark and PDF metadata",
    "Client-side processing for privacy"
  ]
}
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    { "@type": "Question", "name": "Can I convert multiple images to a single PDF?", "acceptedAnswer": { "@type": "Answer", "text": "Yes — you can upload multiple images, reorder them and export as a single PDF file." }},
    { "@type": "Question", "name": "Are my images uploaded to a server?", "acceptedAnswer": { "@type": "Answer", "text": "No — all processing is done client-side in your browser; images are not uploaded." }},
    { "@type": "Question", "name": "Which image formats are supported?", "acceptedAnswer": { "@type": "Answer", "text": "PNG, JPEG, and WebP are supported. Other image formats may work if your browser can display them." }},
    { "@type": "Question", "name": "How do I improve print quality?", "acceptedAnswer": { "@type": "Answer", "text": "Increase the DPI setting and reduce compression to preserve detail for printing. Choose higher DPI (e.g. 300) for photo-quality prints." }},
    { "@type": "Question", "name": "Where is the PDF saved after export?", "acceptedAnswer": { "@type": "Answer", "text": "The PDF is generated in the browser and downloaded to your device. You can also preview the first page in a new tab." }},
    { "@type": "Question", "name": "What should I do if the PDF is too large?", "acceptedAnswer": { "@type": "Answer", "text": "Reduce image resolution or compression quality, or embed as JPEG instead of PNG. For extremely large batches, split into smaller exports." }}
  ]
}
</script>

<!-- External libraries (CDN) -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exifreader@4.12.0/dist/exif-reader.min.js"></script>

<style>
  :root{
    --bg:#f5f7fb; --panel:#fff; --accent:#1f6feb; --muted:#667085;
    --radius:10px; --nav-h:64px; --footer-bg:linear-gradient(180deg,#fff,#fbfdff);
  }
  html,body{height:100%; margin:0; font-family:Inter, Roboto, Arial, sans-serif; background:var(--bg); color:#0b1220;}
  /* NAV */
  .nav {
    position:sticky; top:0; z-index:60;
    height:var(--nav-h); display:flex; align-items:center; gap:20px;
    padding:0 18px; background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
    border-bottom:1px solid rgba(15,23,42,0.04); backdrop-filter: blur(6px);
  }
  .logo {
    width:44px; height:44px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center;
    background:linear-gradient(135deg,var(--accent), #69b3ff); color:white; font-weight:700; font-size:16px;
    box-shadow:0 4px 14px rgba(31,111,235,0.12);
  }
  .nav .links { margin-left:auto; display:flex; gap:12px; align-items:center; }
  .nav a.link { color:var(--muted); text-decoration:none; padding:8px 10px; border-radius:8px; font-size:14px; }
  .nav a.link.active { color:var(--accent); background:rgba(31,111,235,0.06); font-weight:600; }

  /* App container */
  .container {
    max-width:1200px; margin:20px auto; padding:0 18px;
  }

  .app {
    margin-top:6px; padding:22px; background:linear-gradient(180deg,#ffffff 0%, #fbfdff 100%); border-radius:14px; box-shadow:0 8px 30px rgba(20,30,60,0.06);
  }
  h1{margin:0 0 12px; font-size:20px;}
  .top {display:flex; gap:18px; align-items:flex-start;}
  .left, .right {background:var(--panel); padding:16px; border-radius:12px; box-shadow:0 2px 10px rgba(17,24,39,0.04);}
  .left {flex:1; min-width:420px;}
  .right {width:360px;}
  .dropzone {
    border:2px dashed #dbe6ff; border-radius:10px; padding:20px; text-align:center; background:linear-gradient(180deg, rgba(31,111,235,0.03), transparent);
    cursor:pointer; transition:background .12s;
  }
  .dropzone.dragover { background:linear-gradient(180deg, rgba(31,111,235,0.08), transparent); }
  .controls { display:flex; gap:8px; margin-top:12px; align-items:center; flex-wrap:wrap;}
  .btn { background:var(--accent); color:white; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:600;}
  .btn.secondary{ background:#eef4ff; color:var(--accent); }
  .thumbs { display:flex; gap:10px; margin-top:14px; overflow:auto; padding:6px; }
  .thumb { width:110px; min-width:110px; background:#fafbfd; border-radius:8px; padding:8px; display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:center; position:relative;}
  .thumb img { max-width:100%; max-height:70px; display:block; border-radius:6px; background:#fff; object-fit:contain; }
  .thumb .actions { display:flex; gap:6px; }
  .thumb .smallbtn { padding:6px 8px; border-radius:6px; border:1px solid #e6eefc; background:white; cursor:pointer; font-size:12px; }
  label { font-size:13px; color:var(--muted); display:block; margin-bottom:6px;}
  input[type="text"], select, input[type="number"], textarea {
    width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e6eefc; background:white; box-sizing:border-box;
  }
  .section-title { font-weight:700; margin:8px 0; font-size:14px; }
  .progress { height:10px; background:#eef2ff; border-radius:999px; overflow:hidden; margin-top:12px; }
  .progress > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,#2b7cff,#69b3ff); transition:width .2s ease; }
  .muted { color:var(--muted); font-size:13px; }
  .help { font-size:13px; color:var(--muted); margin-top:8px; }

  /* SIMPLIFIED FOOTER */
  footer.simple-footer {
    margin-top:18px; padding:14px 8px; text-align:center; color:var(--muted);
    font-size:13px;
  }
  footer.simple-footer .links { display:inline-flex; gap:14px; align-items:center; flex-wrap:wrap; }
  footer.simple-footer a { color:var(--muted); text-decoration:none; }
  footer.simple-footer a:hover { text-decoration:underline; }

  /* SEO content */
  .seo {
    margin-top:18px; background:transparent; padding:12px 4px; color:#0b1220;
  }
  .seo h2 { margin:0 0 8px; font-size:18px; }
  .seo p { margin:0 0 10px; line-height:1.45; color:#172033; }
  .seo ul { margin:8px 0 12px 20px; color:#172033; }
  .faq { margin-top:12px; border-top:1px solid rgba(15,23,42,0.04); padding-top:12px; }
  .faq h3 { font-size:15px; margin:8px 0; }
  .faq p { margin:0 0 8px; color:#172033; }

  /* HIDE global Remove / Reset / Apply / Cancel buttons */
  /* thumbnail "Remove" button is not rendered in JS; modal action buttons are visually hidden here */
  .crop-controls { display: none !important; }       /* hides Apply / Cancel row in crop modal */
  .cropper-container .top-right { display: none !important; } /* hides Reset/rotate in modal header */

  /* Responsive */
  @media (max-width:960px){
    .top { flex-direction:column; }
    .right { width:100%; }
    .nav .links { display:flex; gap:10px; }
  }
</style>
</head>
<body>

<!-- NAVIGATION -->
<nav class="nav" role="navigation" aria-label="Main navigation">
  <div class="logo" aria-hidden="true" title="Brand logo">
    <svg width="28" height="28" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <defs>
        <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0" stop-color="#1f6feb"/>
          <stop offset="1" stop-color="#69b3ff"/>
        </linearGradient>
      </defs>
      <rect x="4" y="4" width="56" height="56" rx="10" fill="url(#g1)"/>
      <path d="M20 40 L20 24 L28 24 C31.5 24 34 25.8 34 29 C34 32.2 31.5 34 28 34 L22 34" fill="white"/>
      <path d="M36 24 L44 24 L44 40 L36 40 C32.7 40 30 37.3 30 34 L30 30 C30 26.7 32.7 24 36 24 Z" fill="white" opacity="0.94"/>
    </svg>
  </div>

  <div class="links" role="menubar" aria-label="Primary">
    <a class="link active" href="#" onclick="event.preventDefault()">Home</a>
    <a class="link" href="#features" onclick="event.preventDefault(); document.getElementById('features')?.scrollIntoView({behavior:'smooth'})">Features</a>
    <a class="link" href="#" onclick="event.preventDefault()">Help</a>
    <a class="link" href="#" onclick="event.preventDefault()">About</a>
  </div>
</nav>

<!-- MAIN CONTAINER -->
<div class="container">
  <main class="app" id="mainApp" role="main">
    <div style="display:flex;align-items:center;gap:12px;">
      <h1>Advanced Image to PDF Converter</h1>
      <div class="muted">Privacy-first browser tool to convert images to high-quality PDF files.</div>
    </div>

    <div class="top" style="margin-top:12px;">
      <section class="left" aria-labelledby="uploaderTitle">
        <h2 id="uploaderTitle" style="margin-top:0">Upload and prepare images</h2>
        <div id="dropzone" class="dropzone" tabindex="0" aria-describedby="uploaderHelp">
          <div style="font-weight:700">Drag & drop images here</div>
          <div id="uploaderHelp" class="muted">or click to browse. Supports PNG, JPEG, WebP. Paste images too (Ctrl+V).</div>
          <div class="controls">
            <input id="fileInput" type="file" accept="image/*" multiple style="display:none"/>
            <button class="btn" id="btnBrowse">Browse files</button>
            <button class="btn secondary" id="btnClear">Clear all</button>
            <div style="margin-left:auto; display:flex; gap:6px; align-items:center;">
              <label class="muted" style="margin:0 6px 0 0">Images</label>
              <div id="count" class="muted">0</div>
            </div>
          </div>
        </div>

        <div id="thumbs" class="thumbs" aria-live="polite"></div>

        <div class="section-title">Selected image settings</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div style="flex:1; min-width:220px;">
            <label>Global fit mode</label>
            <select id="fitMode">
              <option value="contain">Fit (contain)</option>
              <option value="cover">Fill (cover)</option>
              <option value="stretch">Stretch (may distort)</option>
              <option value="center">Center (no scale)</option>
            </select>
          </div>
          <div style="width:150px;">
            <label>Compression quality</label>
            <input id="quality" type="range" min="0.2" max="1" step="0.05" value="0.9"/>
          </div>
          <div style="width:130px;">
            <label>DPI</label>
            <input id="dpi" type="number" min="72" max="600" value="150"/>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:8px;">
          <button id="btnRotateLeft" class="smallbtn" style="padding:8px 10px;">Rotate ⟲</button>
          <button id="btnRotateRight" class="smallbtn" style="padding:8px 10px;">Rotate ⟳</button>
          <button id="btnCrop" class="smallbtn" style="padding:8px 10px;">Open Crop</button>
          <button id="btnAutoOrient" class="smallbtn" style="padding:8px 10px;">Auto-orient (EXIF)</button>
        </div>

        <div class="section-title">Watermark</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="watermarkText" type="text" placeholder="Optional watermark text (e.g. Confidential)"/>
          <input id="watermarkOpacity" type="range" min="0" max="1" step="0.05" value="0.25" style="width:120px"/>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <label style="width:90px">Font size</label>
          <input id="watermarkSize" type="number" min="8" max="72" value="24" style="width:80px"/>
          <label style="width:90px">Position</label>
          <select id="watermarkPos" style="width:160px">
            <option value="center">Center</option>
            <option value="top-left">Top-left</option>
            <option value="top-right">Top-right</option>
            <option value="bottom-left">Bottom-left</option>
            <option value="bottom-right">Bottom-right</option>
          </select>
        </div>

        <div class="help">Tip: crop or rotate specific thumbnails by selecting the thumbnail controls; re-order pages by dragging thumbnails.</div>
      </section>

      <aside class="right" aria-labelledby="exportTitle">
        <h2 id="exportTitle" style="margin-top:0">PDF export</h2>

        <div class="field">
          <label>Page size</label>
          <select id="pageSize">
            <option value="A4">A4 (210 × 297 mm)</option>
            <option value="Letter">Letter (8.5 × 11 in)</option>
            <option value="Legal">Legal (8.5 × 14 in)</option>
            <option value="Custom">Custom (mm)</option>
          </select>
        </div>
        <div id="customSizeRow" style="display:none; gap:8px; margin-bottom:12px;">
          <div>
            <label>Width (mm)</label>
            <input id="customW" type="number" min="10" value="210"/>
          </div>
          <div>
            <label>Height (mm)</label>
            <input id="customH" type="number" min="10" value="297"/>
          </div>
        </div>

        <div class="field">
          <label>Orientation</label>
          <select id="orientation">
            <option value="portrait">Portrait</option>
            <option value="landscape">Landscape</option>
          </select>
        </div>

        <div class="field">
          <label>Margins (mm)</label>
          <input id="margins" type="number" min="0" value="10"/>
        </div>

        <div class="field">
          <label>PDF metadata</label>
          <input id="pdfTitle" type="text" placeholder="Title"/>
          <input id="pdfAuthor" type="text" placeholder="Author" style="margin-top:8px"/>
          <input id="pdfSubject" type="text" placeholder="Subject" style="margin-top:8px"/>
        </div>

        <div class="field">
          <label>Output filename</label>
          <input id="outName" type="text" value="document.pdf" />
        </div>

        <div class="field">
          <label>Advanced options</label>
          <div style="display:flex; gap:8px;">
            <label style="display:flex; gap:6px; align-items:center;"><input id="embedAsJpg" type="checkbox" checked/> Embed as JPEG when possible</label>
          </div>
        </div>

        <div class="generate">
          <button class="btn" id="btnGenerate">Generate PDF</button>
          <button class="btn secondary" id="btnPreview">Preview 1st page</button>
        </div>

        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100"><i id="progressBar"></i></div>
        <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
          <div class="muted">Status:</div>
          <div id="status" class="muted">Idle</div>
        </div>
      </aside>
    </div>

    <!-- SEO friendly content: extended -->
    <section class="seo" id="features">
      <h2>Fast, private image to PDF conversion</h2>
      <p>
        Convert photos, scans and screenshots into a single PDF in seconds — directly in your browser.
        This tool supports PNG, JPEG and WebP formats and includes controls for page size, DPI, image compression,
        per-image cropping and rotation, and optional visible watermarks. Everything runs client-side so your files remain private.
      </p>

      <h3>Why use this converter?</h3>
      <ul>
        <li><strong>Privacy:</strong> Processing happens locally in your browser — no uploads, no external storage.</li>
        <li><strong>Control:</strong> Fine-grained controls for compression, DPI, margins and page ordering.</li>
        <li><strong>Convenience:</strong> Drag & drop, paste from clipboard, and drag-to-reorder pages.</li>
        <li><strong>Compatibility:</strong> Output is standard PDF readable by Acrobat Reader, macOS Preview, and nearly all PDF viewers.</li>
      </ul>

      <h3>Use cases</h3>
      <ul>
        <li>Photographers preparing contact sheets or proofs for clients.</li>
        <li>Students and educators combining photos of notes and handouts into a single document.</li>
        <li>Legal and real estate professionals compiling scanned documents or images into a single, annotated PDF.</li>
        <li>Small businesses digitizing receipts and invoices for archiving or email distribution.</li>
      </ul>

      <h3>Step-by-step: create a print-ready PDF</h3>
      <ol>
        <li>Upload or paste the images you want to include.</li>
        <li>Use thumbnails to reorder pages by dragging them into the desired sequence.</li>
        <li>Crop or rotate individual images where needed using the Crop control.</li>
        <li>Set page size, orientation and margins in the export panel.</li>
        <li>Adjust compression quality and DPI for either smaller file size or higher print quality.</li>
        <li>Optional: add a watermark and fill in PDF metadata (title, author, subject).</li>
        <li>Click <em>Generate PDF</em> and save the downloaded file to your device.</li>
      </ol>

      <div class="faq" aria-labelledby="faqTitle">
        <h3 id="faqTitle">Frequently asked questions</h3>

        <h4>Is processing local to my device?</h4>
        <p>Yes. All image manipulation and PDF generation happen in your browser — there are no uploads to a remote server.</p>

        <h4>Which browsers are supported?</h4>
        <p>Modern desktop and mobile browsers that support the HTML5 canvas and File APIs (Chrome, Edge, Firefox, Safari, Chromium-based browsers).</p>

        <h4>How do I improve print quality?</h4>
        <p>Increase the DPI setting and reduce compression quality (higher quality) before generating the PDF to get better print-ready output.</p>

        <h4>How can I make the final PDF smaller?</h4>
        <p>Lower the compression quality, choose JPEG embedding when appropriate, or reduce the image DPI. Cropping out unused margins also helps reduce size.</p>

        <h4>What if images appear rotated incorrectly in the PDF?</h4>
        <p>Use the per-image rotate controls or click "Auto-orient (EXIF)" to apply orientation from camera metadata. You can also manually rotate after cropping.</p>
      </div>

      <h3>Best practices & tips</h3>
      <ul>
        <li>For archival scans: use 300 DPI and minimal compression (quality &gt; 0.9).</li>
        <li>For email: use 150 DPI and medium compression (quality around 0.7) to balance size and readability.</li>
        <li>When preserving transparent backgrounds, keep PNG; otherwise, use JPEG for smaller files.</li>
        <li>Use the "Preview" button to check the first page before exporting large batches.</li>
      </ul>

      <h3>Privacy & security</h3>
      <p>
        This converter performs all operations inside the browser. No images, intermediate files, or final PDFs are sent to or stored on remote servers by default.
        If you open the preview in a new tab, that preview URL is a local blob URL that exists only in your browser session.
      </p>

      <h3>Accessibility</h3>
      <p>
        The interface uses semantic landmarks, labeled controls, and ARIA where appropriate. Keyboard navigation works for primary actions; if you rely on assistive technology and encounter an accessibility issue, please report it to the support contact in the footer.
      </p>

      <h3>Changelog (short)</h3>
      <ul>
        <li>v1.3 — Added watermark controls, DPI and compression settings.</li>
        <li>v1.2 — Improved drag-to-reorder thumbs and added Cropper integration.</li>
        <li>v1.0 — Initial release: batch image → PDF conversion with client-side processing.</li>
      </ul>
    </section>
  </main>

  <!-- SIMPLE FOOTER -->
  <footer class="simple-footer" role="contentinfo" aria-label="Footer">
    <div class="links" role="navigation" aria-label="Footer links">
      <a href="#" onclick="event.preventDefault(); document.getElementById('mainApp').scrollIntoView({behavior:'smooth'})">Home</a>
      <a href="#features" onclick="event.preventDefault(); document.getElementById('features').scrollIntoView({behavior:'smooth'})">Features</a>
      <a href="#" onclick="event.preventDefault()">Privacy</a>
      <a href="#" onclick="event.preventDefault()">Terms</a>
      <span style="margin-left:14px;color:var(--muted)">© <span id="year"></span> Your Company</span>
    </div>
  </footer>
</div>

<!-- CROP MODAL (buttons hidden via CSS) -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="cropper-container" role="dialog" aria-modal="true" aria-labelledby="cropTitle">
    <div style="display:flex; align-items:center; gap:10px;">
      <div id="cropTitle" style="font-weight:700; color:white">Crop / Adjust</div>
      <div class="top-right">
        <!-- top-right controls (rotate/reset) are present in DOM but hidden globally via CSS -->
        <button id="cropRotateLeft" class="small">Rotate ⟲</button>
        <button id="cropRotateRight" class="small">Rotate ⟳</button>
        <button id="cropReset" class="small">Reset</button>
      </div>
    </div>
    <div class="crop-area">
      <img id="cropImg" style="max-width:100%; max-height:100%; display:block;" alt="Image for cropping"/>
    </div>
    <div class="crop-controls">
      <!-- Apply / Cancel controls are present in DOM but hidden via CSS -->
      <button id="cropCancel" class="small">Cancel</button>
      <button id="cropApply" class="small" style="background:#1f6feb;color:white;border:none;">Apply</button>
    </div>
  </div>
</div>

<script>
/*
  Advanced Image -> PDF Converter with global hiding of Remove / Reset / Apply / Cancel buttons.
  Buttons remain in the DOM (hidden by CSS) so functionality can be restored easily later.
*/

const { PDFDocument, StandardFonts, rgb } = window.PDFLib;

/* UI Elements */
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const btnBrowse = document.getElementById('btnBrowse');
const btnClear = document.getElementById('btnClear');
const thumbsEl = document.getElementById('thumbs');
const countEl = document.getElementById('count');
const btnGenerate = document.getElementById('btnGenerate');
const btnPreview = document.getElementById('btnPreview');
const progressBar = document.getElementById('progressBar');
const statusEl = document.getElementById('status');
const fitModeEl = document.getElementById('fitMode');
const qualityEl = document.getElementById('quality');
const dpiEl = document.getElementById('dpi');
const pageSizeEl = document.getElementById('pageSize');
const orientationEl = document.getElementById('orientation');
const marginsEl = document.getElementById('margins');
const customSizeRow = document.getElementById('customSizeRow');
const customW = document.getElementById('customW');
const customH = document.getElementById('customH');
const outNameEl = document.getElementById('outName');
const watermarkTextEl = document.getElementById('watermarkText');
const watermarkOpacityEl = document.getElementById('watermarkOpacity');
const watermarkSizeEl = document.getElementById('watermarkSize');
const watermarkPosEl = document.getElementById('watermarkPos');
const embedAsJpgEl = document.getElementById('embedAsJpg');

document.getElementById('year').textContent = new Date().getFullYear();

/* State */
let images = []; // array of {id, file, dataUrl, rotation, cropData, name, width, height}
let currentCropIndex = null;
let cropper = null;

/* Utility: create unique id */
function uid() { return Math.random().toString(36).slice(2,9); }

/* mm -> points */
function mmToPoints(mm) { return mm * 2.8346456693; }

const PAGE_PRESETS = {
  'A4': { w_mm:210, h_mm:297 },
  'Letter': { w_in:8.5, h_in:11 },
  'Legal': { w_in:8.5, h_in:14 }
};

function updateCount(){ countEl.textContent = images.length; }

/* File handling */
btnBrowse.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', (e)=> handleFiles(e.target.files));
btnClear.addEventListener('click', ()=> { images = []; renderThumbs(); });

;['dragenter','dragover'].forEach(ev => {
  dropzone.addEventListener(ev, (e)=> { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover');});
});
;['dragleave','drop'].forEach(ev => {
  dropzone.addEventListener(ev, (e)=> { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover');});
});
dropzone.addEventListener('drop', (e)=>{
  const dt = e.dataTransfer;
  if(dt && dt.files) handleFiles(dt.files);
});
dropzone.addEventListener('click', ()=> fileInput.click());

window.addEventListener('paste', (e)=>{
  if(e.clipboardData){
    const items = e.clipboardData.items;
    const list = [];
    for(let i=0;i<items.length;i++){
      const it = items[i];
      if(it.type && it.type.indexOf && it.type.indexOf('image') !== -1){
        const file = it.getAsFile();
        if(file) list.push(file);
      }
    }
    if(list.length) handleFiles(list);
  }
});

async function handleFiles(fileList){
  const files = Array.from(fileList).filter(f=>f.type && f.type.startsWith('image/'));
  if(files.length === 0) return;
  status('Reading ' + files.length + ' files...');
  for(const f of files){
    const id = uid();
    const dataUrl = await fileToDataURL(f);
    const dims = await getImageSize(dataUrl);
    let orientation = 1;
    try{
      const tags = ExifReader.load(await f.arrayBuffer());
      if(tags && tags.Orientation && tags.Orientation.value) orientation = tags.Orientation.value;
    }catch(err){ /* ignore */ }

    images.push({
      id, file: f, name: f.name, dataUrl, rotation: 0, cropData: null,
      width: dims.width, height: dims.height, exifOrientation: orientation
    });
  }
  renderThumbs();
  status('Loaded ' + images.length + ' images');
}

function fileToDataURL(file){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
function getImageSize(dataUrl){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=> res({width:img.naturalWidth, height:img.naturalHeight});
    img.onerror = rej;
    img.src = dataUrl;
  });
}

/* Thumbnails
   NOTE: "Remove" button intentionally omitted (hidden globally per request).
*/
function renderThumbs(){
  thumbsEl.innerHTML = '';
  images.forEach((img, index) => {
    const div = document.createElement('div');
    div.className = 'thumb';
    div.dataset.id = img.id;
    // Removed the "Remove" button from the markup
    div.innerHTML = `
      <img src="${img.dataUrl}" alt="${escapeHtml(img.name)}"/>
      <div style="font-size:12px; text-align:center; word-break:break-word;">${escapeHtml(img.name)}</div>
      <div class="actions">
        <button class="smallbtn rotate-left" title="Rotate left">⟲</button>
        <button class="smallbtn rotate-right" title="Rotate right">⟳</button>
        <button class="smallbtn crop" title="Crop">Crop</button>
      </div>
    `;
    thumbsEl.appendChild(div);

    div.querySelector('.rotate-left').addEventListener('click', ()=> { rotateImage(img.id, -90); });
    div.querySelector('.rotate-right').addEventListener('click', ()=> { rotateImage(img.id, 90); });
    div.querySelector('.crop').addEventListener('click', ()=> { openCrop(img.id); });
    // "Remove" control intentionally not added
  });

  Sortable.create(thumbsEl, {
    animation: 150,
    onEnd(evt){
      const oldIndex = evt.oldIndex, newIndex = evt.newIndex;
      if(oldIndex === newIndex) return;
      const moved = images.splice(oldIndex,1)[0];
      images.splice(newIndex,0,moved);
      renderThumbs();
    }
  });

  updateCount();
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function rotateImage(id, deg){
  const it = images.find(i=>i.id===id);
  if(!it) return;
  it.rotation = (it.rotation + deg + 3600) % 360;
  applyTransformsToImage(it).then(() => renderThumbs());
}
function removeImage(id){
  // function preserved but not wired to any visible control
  images = images.filter(i=>i.id!==id);
  renderThumbs();
}

async function applyTransformsToImage(imgObj){
  const img = await loadImage(imgObj.dataUrl);
  let sx=0, sy=0, sW=img.width, sH=img.height;
  if(imgObj.cropData){
    sx = imgObj.cropData.x; sy = imgObj.cropData.y;
    sW = imgObj.cropData.width; sH = imgObj.cropData.height;
  }
  const tmp = document.createElement('canvas');
  const rot = (imgObj.rotation || 0) % 360;
  if(rot % 180 === 0){
    tmp.width = sW; tmp.height = sH;
  } else {
    tmp.width = sH; tmp.height = sW;
  }
  const ctx = tmp.getContext('2d');
  ctx.translate(tmp.width/2, tmp.height/2);
  ctx.rotate(rot * Math.PI / 180);
  ctx.drawImage(img, sx, sy, sW, sH, -sW/2, -sH/2, sW, sH);
  const newDataUrl = tmp.toDataURL('image/png');
  imgObj.dataUrl = newDataUrl;
  imgObj.width = tmp.width; imgObj.height = tmp.height;
}

function loadImage(dataUrl){
  return new Promise((res, rej)=>{
    const im = new Image();
    im.onload = ()=> res(im);
    im.onerror = rej;
    im.src = dataUrl;
  });
}

/* Crop modal */
const modal = document.getElementById('modal');
const cropImgEl = document.getElementById('cropImg');
const cropApply = document.getElementById('cropApply');
const cropCancel = document.getElementById('cropCancel');
const cropRotateLeft = document.getElementById('cropRotateLeft');
const cropRotateRight = document.getElementById('cropRotateRight');
const cropReset = document.getElementById('cropReset');

function openCrop(id){
  const idx = images.findIndex(i=>i.id===id);
  if(idx === -1) return;
  currentCropIndex = idx;
  const obj = images[idx];
  cropImgEl.src = obj.dataUrl;
  modal.classList.add('show');
  modal.setAttribute('aria-hidden','false');

  if(cropper) cropper.destroy();
  cropper = new Cropper(cropImgEl, {
    viewMode: 1,
    autoCropArea: 0.9,
    responsive: true,
    background: false,
    zoomOnWheel: true,
    rotatable: true
  });

  // rotate buttons still functional, but visually hidden by CSS
  cropRotateLeft.onclick = ()=> cropper.rotate(-90);
  cropRotateRight.onclick = ()=> cropper.rotate(90);
  cropReset.onclick = ()=> cropper.reset();
}

cropCancel.addEventListener('click', ()=> {
  // hidden control — function preserved
  closeCrop();
});
cropApply.addEventListener('click', async ()=> {
  if(currentCropIndex == null) return;
  const cData = cropper.getData(true);
  const obj = images[currentCropIndex];
  const img = await loadImage(obj.dataUrl);
  const canvas = document.createElement('canvas');
  canvas.width = Math.round(cData.width);
  canvas.height = Math.round(cData.height);
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, cData.x, cData.y, cData.width, cData.height, 0, 0, cData.width, cData.height);
  const newDataUrl = canvas.toDataURL('image/png');
  obj.dataUrl = newDataUrl;
  obj.width = canvas.width; obj.height = canvas.height;
  obj.cropData = null;
  obj.rotation = 0;
  closeCrop();
  renderThumbs();
});

function closeCrop(){
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden','true');
  if(cropper){ cropper.destroy(); cropper = null; }
  currentCropIndex = null;
}

/* EXIF auto-orient */
async function autoOrientAll(){
  status('Auto-orienting images...');
  for(const it of images){
    const o = it.exifOrientation || 1;
    if(o === 1) continue;
    const canvasResult = await applyExifOrientation(it.dataUrl, o);
    it.dataUrl = canvasResult;
    it.rotation = 0;
    it.exifOrientation = 1;
  }
  renderThumbs();
  status('Auto-orient complete');
}
document.getElementById('btnAutoOrient').addEventListener('click', autoOrientAll);

async function applyExifOrientation(dataUrl, orientation){
  const img = await loadImage(dataUrl);
  const w = img.naturalWidth, h = img.naturalHeight;
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  if(orientation >=5 && orientation <=8){
    canvas.width = h; canvas.height = w;
  } else {
    canvas.width = w; canvas.height = h;
  }
  switch(orientation){
    case 2: ctx.transform(-1,0,0,1,w,0); break;
    case 3: ctx.translate(w,h); ctx.rotate(Math.PI); break;
    case 4: ctx.transform(1,0,0,-1,0,h); break;
    case 5: ctx.transform(0,1,1,0,0,0); break;
    case 6: ctx.translate(h,0); ctx.rotate(Math.PI/2); break;
    case 7: ctx.transform(0,-1,-1,0,h,w); break;
    case 8: ctx.translate(0,w); ctx.rotate(-Math.PI/2); break;
    default: break;
  }
  ctx.drawImage(img,0,0);
  return canvas.toDataURL('image/png');
}

/* Bulk rotate/crop shortcuts */
document.getElementById('btnRotateLeft').addEventListener('click', ()=>{
  images.forEach(i=> i.rotation = (i.rotation - 90 + 360) % 360);
  Promise.all(images.map(i=> applyTransformsToImage(i))).then(()=> renderThumbs());
});
document.getElementById('btnRotateRight').addEventListener('click', ()=>{
  images.forEach(i=> i.rotation = (i.rotation + 90) % 360);
  Promise.all(images.map(i=> applyTransformsToImage(i))).then(()=> renderThumbs());
});
document.getElementById('btnCrop').addEventListener('click', ()=>{
  if(images.length>0) openCrop(images[0].id);
});

/* PDF generation */
btnGenerate.addEventListener('click', ()=> generatePDF({preview:false}));
btnPreview.addEventListener('click', ()=> generatePDF({preview:true}));

/* Page size calculation */
function computePageSizePoints(){
  const preset = pageSizeEl.value;
  let wPt, hPt;
  if(preset === 'Custom'){
    const wmm = parseFloat(customW.value) || 210;
    const hmm = parseFloat(customH.value) || 297;
    wPt = mmToPoints(wmm); hPt = mmToPoints(hmm);
  } else if(preset === 'A4'){
    const p = PAGE_PRESETS.A4;
    wPt = mmToPoints(p.w_mm); hPt = mmToPoints(p.h_mm);
  } else {
    const p = PAGE_PRESETS[preset];
    const wIn = p.w_in; const hIn = p.h_in;
    wPt = wIn * 72; hPt = hIn * 72;
  }
  if(orientationEl.value === 'landscape') [wPt,hPt] = [hPt,wPt];
  return {wPt, hPt};
}

/* Main generator */
async function generatePDF({ preview=false } = {}){
  if(images.length === 0){ alert('Add images first'); return; }
  btnGenerate.disabled = true;
  btnPreview.disabled = true;
  progress(0);
  status('Preparing PDF...');

  try{
    const pdfDoc = await PDFDocument.create();
    const title = document.getElementById('pdfTitle').value.trim();
    const author = document.getElementById('pdfAuthor').value.trim();
    const subject = document.getElementById('pdfSubject').value.trim();
    if(title) pdfDoc.setTitle(title);
    if(author) pdfDoc.setAuthor(author);
    if(subject) pdfDoc.setSubject(subject);

    const { wPt, hPt } = computePageSizePoints();
    const marginMM = parseFloat(marginsEl.value) || 10;
    const marginPt = mmToPoints(marginMM);

    const fitMode = fitModeEl.value;
    const quality = parseFloat(qualityEl.value);
    const dpi = parseInt(dpiEl.value,10) || 150;
    const embedAsJpg = embedAsJpgEl.checked;
    const watermarkText = watermarkTextEl.value.trim();
    const watermarkOpacity = parseFloat(watermarkOpacityEl.value) || 0.25;
    const watermarkSize = parseFloat(watermarkSizeEl.value) || 24;
    const watermarkPos = watermarkPosEl.value;
    const pagesCount = images.length;

    for(let idx=0; idx<pagesCount; idx++){
      const imgObj = images[idx];
      status(`Processing image ${idx+1} / ${pagesCount}`);
      progress( Math.round((idx/pagesCount) * 100) );

      const processed = await renderImageForPdf(imgObj, { dpi, quality, fitMode, targetPtWidth: wPt - 2*marginPt, targetPtHeight: hPt - 2*marginPt });

      let embeddedImage;
      if(embedAsJpg && processed.mime === 'image/png'){
        const jpegBlob = await blobToJpeg(processed.blob, quality);
        const arrayBuf = await jpegBlob.arrayBuffer();
        embeddedImage = await pdfDoc.embedJpg(arrayBuf);
      } else if(processed.mime === 'image/png'){
        const arrayBuf = await processed.blob.arrayBuffer();
        embeddedImage = await pdfDoc.embedPng(arrayBuf);
      } else if(processed.mime.startsWith('image/jpeg')){
        const arrayBuf = await processed.blob.arrayBuffer();
        embeddedImage = await pdfDoc.embedJpg(arrayBuf);
      } else {
        const arrayBuf = await processed.blob.arrayBuffer();
        embeddedImage = await pdfDoc.embedPng(arrayBuf);
      }

      const page = pdfDoc.addPage([wPt, hPt]);
      const targetW = wPt - 2*marginPt;
      const targetH = hPt - 2*marginPt;
      const imgWpt = (processed.width_px / processed.dpi) * 72;
      const imgHpt = (processed.height_px / processed.dpi) * 72;
      let drawW = imgWpt, drawH = imgHpt;

      if(fitMode === 'contain'){
        const scale = Math.min(targetW / imgWpt, targetH / imgHpt, 1);
        drawW = imgWpt * scale; drawH = imgHpt * scale;
      } else if(fitMode === 'cover'){
        const scale = Math.max(targetW / imgWpt, targetH / imgHpt);
        drawW = imgWpt * scale; drawH = imgHpt * scale;
      } else if(fitMode === 'stretch'){
        drawW = targetW; drawH = targetH;
      } else if(fitMode === 'center'){
        drawW = imgWpt; drawH = imgHpt;
      }

      let x = marginPt + (targetW - drawW)/2;
      let y = marginPt + (targetH - drawH)/2;

      page.drawImage(embeddedImage, { x, y, width: drawW, height: drawH });

      if(watermarkText){
        const helv = await pdfDoc.embedFont(StandardFonts.Helvetica);
        const wmSize = watermarkSize;
        const textWidth = helv.widthOfTextAtSize(watermarkText, wmSize);
        let tx = 0, ty = 0;
        if(watermarkPos === 'center'){ tx = (wPt - textWidth)/2; ty = (hPt - wmSize)/2; }
        if(watermarkPos === 'top-left'){ tx = marginPt; ty = hPt - marginPt - wmSize; }
        if(watermarkPos === 'top-right'){ tx = wPt - marginPt - textWidth; ty = hPt - marginPt - wmSize; }
        if(watermarkPos === 'bottom-left'){ tx = marginPt; ty = marginPt; }
        if(watermarkPos === 'bottom-right'){ tx = wPt - marginPt - textWidth; ty = marginPt; }
        page.drawText(watermarkText, {
          x: tx, y: ty,
          size: wmSize,
          font: helv,
          color: rgb(0,0,0),
          opacity: watermarkOpacity,
        });
      }

      await sleep(10);
    }

    progress(100);
    status('Finalizing PDF...');
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], {type:'application/pdf'});
    if(preview){
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    } else {
      saveAs(blob, outNameEl.value || 'document.pdf');
    }
    status('Done');
  } catch (err){
    console.error(err);
    alert('Error: ' + (err.message || err));
    status('Error');
  } finally {
    btnGenerate.disabled = false;
    btnPreview.disabled = false;
    progress(0);
  }
}

/* Render image for PDF */
async function renderImageForPdf(imgObj, { dpi=150, quality=0.9, fitMode='contain', targetPtWidth, targetPtHeight }){
  const img = await loadImage(imgObj.dataUrl);
  const targetPxW = Math.round(targetPtWidth * dpi / 72);
  const targetPxH = Math.round(targetPtHeight * dpi / 72);

  let srcW = img.naturalWidth, srcH = img.naturalHeight;
  let drawW = srcW, drawH = srcH;
  if(fitMode === 'contain'){
    const scale = Math.min(targetPxW / srcW, targetPxH / srcH, 1);
    drawW = Math.round(srcW * scale); drawH = Math.round(srcH * scale);
  } else if(fitMode === 'cover'){
    const scale = Math.max(targetPxW / srcW, targetPxH / srcH);
    drawW = Math.round(srcW * scale); drawH = Math.round(srcH * scale);
  } else if(fitMode === 'stretch'){
    drawW = targetPxW; drawH = targetPxH;
  } else if(fitMode === 'center'){
    drawW = srcW; drawH = srcH;
  }

  const canvas = document.createElement('canvas');
  canvas.width = Math.max(1, drawW);
  canvas.height = Math.max(1, drawH);
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, 0, 0, srcW, srcH, 0,0, canvas.width, canvas.height);

  const preferJpg = embedAsJpgEl.checked;
  let mime = 'image/png';
  let blob;
  if(preferJpg){
    blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', quality));
    mime = 'image/jpeg';
  } else {
    blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    mime = 'image/png';
  }
  return { mime, blob, width_px: canvas.width, height_px: canvas.height, dpi };
}

/* convert blob -> jpeg */
async function blobToJpeg(blob, quality=0.9){
  const url = URL.createObjectURL(blob);
  const img = await loadImage(url);
  const canvas = document.createElement('canvas');
  canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,canvas.width, canvas.height);
  ctx.drawImage(img,0,0);
  return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', quality));
}

/* helpers */
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
function progress(p){ progressBar.style.width = (p) + '%'; }
function status(s){ statusEl.textContent = s; }

/* init UI */
(function initUI(){
  pageSizeEl.addEventListener('change', ()=> {
    if(pageSizeEl.value === 'Custom') customSizeRow.style.display = 'flex';
    else customSizeRow.style.display = 'none';
  });

  renderThumbs();
})();

/* debug helper */
function listImages(){
  console.table(images.map(i=>({name:i.name, w:i.width, h:i.height, rot:i.rotation})));
}
window.listImages = listImages;

status('Idle');
</script>
</body>
</html>
