<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Advanced Passport Photo Maker</title>
		<!-- Bootstrap CSS & Icons -->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
			rel="stylesheet"
		/>
		<!-- Cropper.js CSS -->
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
			rel="stylesheet"
		/>
		<style>
			body {
				background-color: #f8f9fa;
			}
			#canvas-container {
				position: relative;
				width: 100%;
				background: #000;
				border-radius: 0.5rem;
				overflow: hidden;
			}
			#canvas-container img {
				width: 100%;
				display: block;
			}
			#guide {
				position: absolute;
				border: 2px dashed rgba(255, 255, 255, 0.8);
				pointer-events: none;
			}
			.preview-card {
				height: 200px;
			}
			.preview-canvas {
				width: auto;
				height: 100%;
				display: block;
				margin: 0 auto;
				background: #fff;
			}
		</style>
	</head>
	<body>
		<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
			<div class="container-fluid">
				<a class="navbar-brand" href="#"
					><i class="bi bi-camera-reels-fill me-2"></i>Passport Photo Maker</a
				>
				<div class="ms-auto" style="width: 300px">
					<input
						type="file"
						id="photoInput"
						accept="image/*"
						class="form-control"
					/>
				</div>
			</div>
		</nav>
		<div class="container">
			<div class="row g-4">
				<div class="col-lg-7">
					<div id="canvas-container" class="mb-3">
						<img id="image" alt="Upload" style="visibility: hidden" />
						<div id="guide"></div>
					</div>
					<div class="d-flex gap-2 mb-3">
						<button id="cropBtn" class="btn btn-primary flex-fill" disabled>
							<i class="bi bi-scissors me-1"></i> Crop & Generate Sheet
						</button>
						<button id="downloadBtn" class="btn btn-success flex-fill" disabled>
							<i class="bi bi-download me-1"></i> Download Sheet
						</button>
					</div>
				</div>
				<div class="col-lg-5">
					<div class="card shadow-sm">
						<div class="card-header">
							<i class="bi bi-sliders me-2"></i>Settings & Preview
						</div>
						<div class="card-body">
							<form id="settingsForm" class="row g-3">
								<!-- Custom Photo Size -->
								<div class="col-md-6">
									<label for="photoWidthInput" class="form-label"
										>Photo Width</label
									>
									<div class="input-group">
										<input
											type="number"
											id="photoWidthInput"
											class="form-control"
											value="35"
											min="1"
											step="0.1"
										/>
										<span class="input-group-text">mm</span>
									</div>
								</div>
								<div class="col-md-6">
									<label for="photoHeightInput" class="form-label"
										>Photo Height</label
									>
									<div class="input-group">
										<input
											type="number"
											id="photoHeightInput"
											class="form-control"
											value="45"
											min="1"
											step="0.1"
										/>
										<span class="input-group-text">mm</span>
									</div>
								</div>
								<!-- Print Layout -->
								<div class="col-md-6">
									<label for="layoutSelect" class="form-label"
										>Print Layout</label
									>
									<select id="layoutSelect" class="form-select">
										<option value="1_1">1×1</option>
										<option value="2_2">2×2</option>
										<option value="2_3">2×3</option>
										<option value="2_4">2×4</option>
										<option value="3_4">3×4</option>
										<option value="3_2">3×2</option>
										<option value="3_3">3×3</option>
									</select>
								</div>
								<!-- DPI -->
								<div class="col-md-6">
									<label for="dpiInput" class="form-label">DPI</label>
									<div class="input-group">
										<input
											type="number"
											id="dpiInput"
											class="form-control"
											value="300"
											min="72"
											max="1200"
										/>
										<span class="input-group-text">dpi</span>
									</div>
								</div>
								<!-- Margin -->
								<div class="col-md-6">
									<label for="marginInput" class="form-label">Margin</label>
									<div class="input-group">
										<input
											type="number"
											id="marginInput"
											class="form-control"
											value="2"
											min="0"
											step="0.1"
										/>
										<span class="input-group-text">mm</span>
									</div>
								</div>
								<!-- Bleed -->
								<div class="col-md-6">
									<label for="bleedInput" class="form-label">Bleed</label>
									<div class="input-group">
										<input
											type="number"
											id="bleedInput"
											class="form-control"
											value="3"
											min="0"
											step="0.1"
										/>
										<span class="input-group-text">mm</span>
									</div>
								</div>
								<!-- Fill Entire Page -->
								<div class="col-md-6">
									<label for="fillPage" class="form-label"
										>Fill Entire Page</label
									>
									<div class="form-check form-switch">
										<input
											class="form-check-input"
											type="checkbox"
											id="fillPage"
										/>
										<label class="form-check-label" for="fillPage"
											>Auto-calculate grid to fill sheet</label
										>
									</div>
								</div>
								<!-- Background -->
								<div class="col-md-6">
									<label for="backgroundSelect" class="form-label"
										>Background</label
									>
									<select id="backgroundSelect" class="form-select">
										<option value="#FFFFFF">White</option>
										<option value="#EEEEEE">Light Gray</option>
										<option value="#ADD8E6">Light Blue</option>
									</select>
								</div>
								<!-- Paper Size -->
								<div class="col-md-12">
									<label for="paperSelect" class="form-label">Paper Size</label>
									<select id="paperSelect" class="form-select">
										<option value="A4">A4 (210×297 mm)</option>
										<option value="Letter">Letter (216×279 mm)</option>
										<option value="Custom">Custom</option>
									</select>
								</div>
								<div class="col-md-6" id="customW" style="display: none">
									<label for="paperWidthInput" class="form-label"
										>Paper Width</label
									>
									<div class="input-group">
										<input
											type="number"
											id="paperWidthInput"
											class="form-control"
											value="210"
											step="0.1"
										/>
										<span class="input-group-text">mm</span>
									</div>
								</div>
								<div class="col-md-6" id="customH" style="display: none">
									<label for="paperHeightInput" class="form-label"
										>Paper Height</label
									>
									<div class="input-group">
										<input
											type="number"
											id="paperHeightInput"
											class="form-control"
											value="297"
											step="0.1"
										/>
										<span class="input-group-text">mm</span>
									</div>
								</div>
							</form>
							<div class="mt-4">
								<h6><i class="bi bi-image me-1"></i>Sheet Preview</h6>
								<div class="card preview-card shadow-sm">
									<canvas
										id="sheetPreviewCanvas"
										class="preview-canvas"
									></canvas>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Dependencies -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script
			defer
			src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"
		></script>
		<script>
			async function initFaceApi() {
				await faceapi.nets.tinyFaceDetector.loadFromUri(
					"https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/"
				);
			}
			initFaceApi();

			const photoInput = document.getElementById("photoInput");
			const image = document.getElementById("image");
			const guide = document.getElementById("guide");
			const cropBtn = document.getElementById("cropBtn");
			const downloadBtn = document.getElementById("downloadBtn");
			const sheetPreview = document.getElementById("sheetPreviewCanvas");
			const photoWidthInput = document.getElementById("photoWidthInput");
			const photoHeightInput = document.getElementById("photoHeightInput");
			const layoutSelect = document.getElementById("layoutSelect");
			const dpiInput = document.getElementById("dpiInput");
			const marginInput = document.getElementById("marginInput");
			const bleedInput = document.getElementById("bleedInput");
			const fillPageCheckbox = document.getElementById("fillPage");
			const backgroundSelect = document.getElementById("backgroundSelect");
			const paperSelect = document.getElementById("paperSelect");
			const customW = document.getElementById("customW");
			const customH = document.getElementById("customH");
			const paperWidthInput = document.getElementById("paperWidthInput");
			const paperHeightInput = document.getElementById("paperHeightInput");
			let cropper;

			const paperSizes = { A4: { w: 210, h: 297 }, Letter: { w: 216, h: 279 } };
			paperSelect.addEventListener("change", () => {
				if (paperSelect.value === "Custom") {
					customW.style.display = "block";
					customH.style.display = "block";
				} else {
					customW.style.display = "none";
					customH.style.display = "none";
					const s = paperSizes[paperSelect.value];
					paperWidthInput.value = s.w;
					paperHeightInput.value = s.h;
				}
			});

			photoInput.addEventListener("change", async (e) => {
				const file = e.target.files[0];
				if (!file) return;
				image.src = URL.createObjectURL(file);
				image.style.visibility = "visible";
				await new Promise((res) => (image.onload = res));
				if (cropper) cropper.destroy();
				const pw = parseFloat(photoWidthInput.value);
				const ph = parseFloat(photoHeightInput.value);
				cropper = new Cropper(image, {
					aspectRatio: pw / ph,
					viewMode: 1,
					autoCropArea: 0.8,
					ready: () => {
						const rect = image.getBoundingClientRect();
						const w = rect.width * 0.7;
						const h = rect.height * 0.8;
						guide.style.width = w + "px";
						guide.style.height = h + "px";
						guide.style.left = (rect.width - w) / 2 + "px";
						guide.style.top = (rect.height - h) / 2 + "px";
						cropBtn.disabled = false;
					},
				});
			});

			cropBtn.addEventListener("click", () => {
				const pwMm = parseFloat(photoWidthInput.value);
				const phMm = parseFloat(photoHeightInput.value);
				const dpi = parseInt(dpiInput.value, 10);
				const mmToIn = 1 / 25.4;
				const trimW = Math.round(pwMm * mmToIn * dpi);
				const trimH = Math.round(phMm * mmToIn * dpi);
				let marginPx = Math.round(parseFloat(marginInput.value) * mmToIn * dpi);
				const bleedPx = Math.round(parseFloat(bleedInput.value) * mmToIn * dpi);
				const fillPage = fillPageCheckbox.checked;
				const bg = backgroundSelect.value;

				const paperWpx = Math.round(
					parseFloat(paperWidthInput.value) * mmToIn * dpi
				);
				const paperHpx = Math.round(
					parseFloat(paperHeightInput.value) * mmToIn * dpi
				);

				let cols, rows;
				if (fillPage) {
					marginPx = 0;
					cols = Math.floor(paperWpx / (trimW + bleedPx * 2));
					rows = Math.floor(paperHpx / (trimH + bleedPx * 2));
				} else {
					[cols, rows] = layoutSelect.value.split("_").map(Number);
				}

				const trimmed = cropper.getCroppedCanvas({
					width: trimW,
					height: trimH,
				});
				const totalW = trimW + bleedPx * 2;
				const totalH = trimH + bleedPx * 2;
				const single = document.createElement("canvas");
				single.width = totalW;
				single.height = totalH;
				const ctx1 = single.getContext("2d");
				ctx1.fillStyle = bg;
				ctx1.fillRect(0, 0, totalW, totalH);
				ctx1.drawImage(trimmed, bleedPx, bleedPx);

				const sheet = document.createElement("canvas");
				sheet.width = paperWpx;
				sheet.height = paperHpx;
				const ctx = sheet.getContext("2d");
				ctx.fillStyle = bg;
				ctx.fillRect(0, 0, paperWpx, paperHpx);
				for (let y = 0; y < rows; y++)
					for (let x = 0; x < cols; x++) {
						ctx.drawImage(single, x * totalW, y * totalH);
					}

				sheetPreview.width = sheet.width;
				sheetPreview.height = sheet.height;
				const pctx = sheetPreview.getContext("2d");
				pctx.drawImage(sheet, 0, 0);
				downloadBtn.disabled = false;
				downloadBtn.dataset.url = sheet.toDataURL("image/jpeg");
			});

			downloadBtn.addEventListener("click", () => {
				const a = document.createElement("a");
				a.href = downloadBtn.dataset.url;
				a.download = "passport_sheet.jpg";
				a.click();
			});
		</script>
	</body>
</html>
